<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta charset="utf-8" />
    <title>管理平台首页</title>

    <meta name="description" content="overview &amp; stats" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />

    <!-- bootstrap & fontawesome -->
    <link rel="stylesheet" href="/static/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/static/assets/font-awesome/4.5.0/css/font-awesome.min.css" />

    <!-- page specific plugin styles -->

    <!-- text fonts -->
    <link rel="stylesheet" href="/static/assets/css/fonts.googleapis.com.css" />

    <!-- ace styles -->
    <link rel="stylesheet" href="/static/assets/css/ace.min.css" class="ace-main-stylesheet" id="main-ace-style" />

    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/static/assets/css/ace-part2.min.css" class="ace-main-stylesheet" />
    <![endif]-->
    <link rel="stylesheet" href="/static/assets/css/ace-skins.min.css" />
    <link rel="stylesheet" href="/static/assets/css/ace-rtl.min.css" />

    <!--[if lte IE 9]>
    <link rel="stylesheet" href="/static/assets/css/ace-ie.min.css" />
    <![endif]-->

    <!-- inline styles related to this page -->

    <!-- ace settings handler -->
    <script src="/static/assets/js/ace-extra.min.js"></script>

    <!-- HTML5shiv and Respond.js for IE8 to support HTML5 elements and media queries -->

    <!--[if lte IE 8]>
    <script src="/static/assets/js/html5shiv.min.js"></script>
    <script src="/static/assets/js/respond.min.js"></script>
    <![endif]-->
</head>

<body class="no-skin">

<div class="main-container ace-save-state" id="main-container">
    <script type="text/javascript">
        try{ace.settings.loadState('main-container')}catch(e){}
    </script>


    <div class="main-content">
        <div class="main-content-inner">

            <div class="page-content">

                <div class="row">
                    <div class="col-xs-12">
                        <!-- PAGE CONTENT BEGINS -->
                        <div class="alert alert-block alert-success">
                            <button type="button" class="close" data-dismiss="alert">
                                <i class="ace-icon fa fa-times"></i>
                            </button>

                            <i class="ace-icon fa fa-check green"></i>

                            欢迎访问开源内容管理平台，您可以点击链接进入后台首页&emsp;&emsp;
                            <strong class="green">
                                <a href="/admin">进入管理后台</a>
                            </strong>
                            &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;测试账号：test &emsp;密码：123456 &emsp;只为开源分享，请勿破坏平台，若您有疑问或需要源代码，可进QQ群 1062428023 咨询和下载
                        
                        </div>
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="widget-box">
                                    <div class="widget-header">
                                        <h4 class="widget-title lighter smaller">
                                            <i class="ace-icon fa fa-comment blue"></i>
                                            聊天案例  &emsp;当前在线人数(<strong style="color: red" id="groupcount">1</strong>)人
                                        </h4>
                                    </div>

                                    <div class="widget-body">
                                        <style type="text/css">
                                            #box {
                                                height: 600px;
                                                overflow-x: hidden;
                                                overflow-y: scroll;
                                            }
                                          
                                        </style>
                                        <div class="widget-main no-padding">
                                            <div class="dialogs" id="box">

                                            </div>

                                            <form onsubmit="$('#send').click();return false;">
                                                <div class="form-actions">
                                                    <div class="input-group">
                                                        <input placeholder="Type your message here ..." type="text" class="form-control" name="message" id="message" />
                                                        <span class="input-group-btn">
															<button id="send" class="btn btn-sm btn-info no-radius" type="button">
																<i class="ace-icon fa fa-share"></i>
																Send
															</button>
														</span>
                                                    </div>
                                                </div>
                                            </form>
                                        </div><!-- /.widget-main -->
                                    </div><!-- /.widget-body -->
                                </div><!-- /.widget-box -->
                            </div><!-- /.col -->
                        </div><!-- /.row -->

                        <!-- PAGE CONTENT ENDS -->
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div><!-- /.page-content -->
        </div>
    </div><!-- /.main-content -->

  {{template "admin/common/footer.html" .}}
</div><!-- /.main-container -->

<!-- basic scripts -->

<!--[if !IE]> -->
<script src="/static/assets/js/jquery-2.1.4.min.js"></script>

<!-- <![endif]-->

<!--[if IE]>
<script src="/static/assets/js/jquery-1.11.3.min.js"></script>
<![endif]-->
<script type="text/javascript">
    if('ontouchstart' in document.documentElement) document.write("<script src='/static/assets/js/jquery.mobile.custom.min.js'>"+"<"+"/script>");
</script>
<script src="/static/assets/js/bootstrap.min.js"></script>

<!-- page specific plugin scripts -->

<!--[if lte IE 8]>
<script src="/static/assets/js/excanvas.min.js"></script>
<![endif]-->
<script src="/static/assets/js/jquery-ui.custom.min.js"></script>
<script src="/static/assets/js/jquery.ui.touch-punch.min.js"></script>
<script src="/static/assets/js/jquery.easypiechart.min.js"></script>
<script src="/static/assets/js/jquery.sparkline.index.min.js"></script>
<script src="/static/assets/js/jquery.flot.min.js"></script>
<script src="/static/assets/js/jquery.flot.pie.min.js"></script>
<script src="/static/assets/js/jquery.flot.resize.min.js"></script>

<!-- ace scripts -->
<script src="/static/assets/js/ace-elements.min.js"></script>
<script src="/static/assets/js/ace.min.js"></script>
        <script src="/static/assets/js/bootbox.js"></script>

<script type="text/javascript">
        var conn;
        setInterval(function(){
           if(conn == undefined || conn==null || conn=='undefined' ||  conn=='' || conn.readyState != 1){
              initWebSocket()
           }
        },10000)
        window.onload = function () {
        if (window["WebSocket"]) {
           initWebSocket()
        } else {
            console("Your browser does not support WebSockets.")
        }
    };

    function initWebSocket(){
            conn = new WebSocket("ws://" + document.location.host + "/ws");  
            conn.onclose = function (evt) { };
            conn.onopen = function (evt) { };
            conn.onmessage = function (evt) {
                msg = eval("("+evt.data+")")
                if(msg.type == "ping"){
                    var obj = {};
                    obj.type = "pong";
                    obj = JSON.stringify(obj);
                    conn.send(obj);
                    return
                }
                if(msg.type == "join"){
                    $.post(location.href,{client_id:msg.clientid},function (res) {})
                    return
                }
                if(msg.type == "groupcount"){
                    $("#groupcount").text(msg.message)
                    return
                }
                if(msg.type == "chat"){
                    addMsg( eval("("+msg.message+")"),1)
                }
            };
    }

        function addMsg(message,type){
            if(type == 1){
                var messageArr  = new Array()
                messageStr = localStorage.getItem("messagestr");
                if(messageStr != "" && messageStr != "null" && messageStr != null){
                    messageArr = messageStr.split("||"); //字符分割
                }

                if(messageArr.length > 6){
                    messageArr.shift()
                }
                messageArr.push(JSON.stringify(message))
                localStorage.setItem("messagestr",messageArr.join("||"));
            }
            var sex = parseInt(message.sex)
            if(sex < 20){
                headimg = '/static/assets/images/avatars/avatar.png'
            }else if(sex <40){
                headimg = '/static/assets/images/avatars/avatar1.png'
            }else if(sex <60){
                headimg = '/static/assets/images/avatars/avatar3.png'
            }else if(sex <80){
                headimg = '/static/assets/images/avatars/avatar4.png'
            }else{
                headimg = '/static/assets/images/avatars/avatar5.png'
            }
            if(message.sessionid == createRandomId()){
                sessionStr = "【自己】"
            }else{
                sessionStr = "【游客】"
            }
            var  html = '<div class="itemdiv dialogdiv">';
            html += ' <div class="user">';
            html += ' <img src="'+headimg+'">';
            html += '</div>';
            html += '<div class="body">';
            html += '<div class="time">';
            html += '<i class="ace-icon fa fa-clock-o"></i>';
            html += '<span class="green">'+message.time+'</span>';
            html += ' </div>';
            html += '<div class="name">';
            html += '<a href="#">'+sessionStr+message.nickname+'</a>';
            html += ' </div>';
            html += '<div class="text">'+message.content+'</div>';
            html += ' </div>';
            html += '</div>';
            $("#box").append(html)
            var div = document.getElementById('box');
            div.scrollTop = div.scrollHeight;
        }


    $(function(){
        $("#send").click(function(){
            var content = $.trim($("#message").val())
            if(content == ""){
                return
            }
            var nickname = localStorage.getItem("nickname");
            var sex = localStorage.getItem("sex");
            if(nickname==undefined || nickname=="" || nickname == "null" || nickname == null){
                bootbox.prompt("请填写您的昵称",
                    function(result) {
                    if (result != null && result != "") {
                       localStorage.setItem("nickname",result);
                       localStorage.setItem("sex",Math.ceil(Math.random()*100));
                       $("#send").click()
                    } 
                });                
            }else{
                var myDate = new Date();
                var message = {};
                message.nickname = nickname
                message.sex = sex
                message.content = content
                message.time = myDate.toLocaleString( );
                message.sessionid = createRandomId()

                addMsg(message,1)

                var obj = {};
                obj.type = "chat";
                obj.message = JSON.stringify(message);
                obj = JSON.stringify(obj);
                conn.send(obj);
                $("#message").val("")

            }
        })
    })


// 调用

function createRandomId() {
    var sessionid = localStorage.getItem("web_socket_sessionid");
    if(sessionid==undefined || sessionid=="" || sessionid == "null" || sessionid == null){
       sessionid = (Math.random()*10000000).toString(16).substr(0,4)+'-'+(new Date()).getTime()+'-'+Math.random().toString().substr(2,5);
       localStorage.setItem("web_socket_sessionid",sessionid)             
    }
    return sessionid
}

        var messageArr  = new Array()
        messageStr = localStorage.getItem("messagestr");
        if(messageStr != "" && messageStr != "null" && messageStr != null){
            messageArr = messageStr.split("||"); //字符分割
        }
        if(messageArr.length > 0){
            for(var i=0;i<messageArr.length;i++){
                addMsg( eval("("+messageArr[i]+")"),0)
            }
        }

</script>
</body>
</html>
